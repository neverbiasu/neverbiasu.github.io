"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[8573],{6262:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,i]of t)a[e]=i;return a}},7083:(e,t,a)=>{a.r(t),a.d(t,{comp:()=>n,data:()=>r});var i=a(641);const s={},n=(0,a(6262).A)(s,[["render",function(e,t){return(0,i.uX)(),(0,i.CE)("div",null,t[0]||(t[0]=[(0,i.Fv)('<h1 id="what-is-block-merging" tabindex="-1"><a class="header-anchor" href="#what-is-block-merging"><span>What is Block Merging?</span></a></h1><div class="hint-container warning"><p class="hint-container-title">NOTE</p><p>This guide is still work in progress. Any and all feedback is highly appreciated, it doesn&#39;t have to be suggestions, even questions regarding things you didn&#39;t understand can help me figure out what to refine.</p></div><h2 id="changelog" tabindex="-1"><a class="header-anchor" href="#changelog"><span>Changelog</span></a></h2><ul><li>2023/03/10:<br> - More links</li><li>2023/03/01:<br> - Added section with links to other guides/related scripts and tools</li><li>2023/02/03:<br> - Reworked base_alpha section<br> - Removed outdated workflow section</li><li>2023/01/31:<br> - Updated optional &quot;what do you need&quot; section<br> - Updated some screenshots<br> - Removed &#39;merge order section&#39; as it contained incorrect information. Merge order does NOT influence outcome if your models aren&#39;t broken.</li><li>2023/01/26:<br> - Updated section about XYZ Plots<br> - Noticed mistakes, don&#39;t use this guide for now</li><li>2023/01/25: Asked for some clarification from the devs of the block merge ui, it seems my explanation of the text encoder is incorrect.<br> Disregard that section for the moment.</li></ul><p>Have <em>you</em> wanted to try merging models using the Block Merge script, but couldn&#39;t make sense of the explanation provided by the git repository?<br> You&#39;re in luck, researchanon got you covered:</p><h2 id="table-of-contents" tabindex="-1"><a class="header-anchor" href="#table-of-contents"><span>Table of Contents</span></a></h2><ol><li><a href="#what-is-block-merging-1">What is Block merging?</a><ol><li><a href="#the-basics">The basics</a></li><li><a href="#the-layers">The layers</a></li><li><a href="#what-do-i-need-to-get-started">What do I need to get started?</a><ol><li><a href="#mandatory">Mandatory</a></li><li><a href="#optional">Optional</a></li></ol></li></ol></li><li><a href="#understanding-the-interface">Understanding the interface</a><ol><li><a href="#tangent-understanding-the-weight-values-field">Tangent: Understanding the Weight Values field</a></li><li><a href="#comparing-results">Comparing results</a><ol><li><a href="#classical-block-merge-equivalency">Classical / Block Merge equivalency</a></li></ol></li></ol></li><li><a href="#block-merging-whats-what">Block Merging: what&#39;s what</a><ol><li><a href="#base_alpha-the-text-encoder">base_alpha / the text encoder</a></li><li><a href="#unet-weight-mixing">UNet Weight Mixing</a><ol><li><a href="#mix-presets">Mix Presets</a></li></ol></li><li><a href="#recipes">Recipes</a><ol><li><a href="#mwb-each">MWB Each</a><ol><li><a href="#base_alpha-test-recipe">Base_Alpha Test Recipe</a></li><li><a href="#ratio-test-recipe">Ratio Test Recipe</a></li><li><a href="#input-layer-swap-test-recipe">Input Layer Swap Test Recipe</a></li><li><a href="#output-layer-swap-test-recipe">Output Layer Swap Test Recipe</a></li></ol></li></ol></li></ol></li><li><a href="#links-and-other-guides">Links and other guides</a></li></ol><h2 id="what-is-block-merging-1" tabindex="-1"><a class="header-anchor" href="#what-is-block-merging-1"><span>What is Block merging?</span></a></h2><h3 id="the-basics" tabindex="-1"><a class="header-anchor" href="#the-basics"><span>The basics</span></a></h3><p>(Some info sourced from a DeepL translation of <a href="https://note.com/kohya_ss/n/n9a485a066d5b" target="_blank" rel="noopener noreferrer">this</a> blogpost, but mostly original research):</p><p>Stable Diffusion consists of Text Encoder (CLIP), Denoising Auto Encoder (U-Net) and Variable Auto Encoder (VAE). Of these, U-Net is responsible for generating images from noise.</p><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Scarily complex looking image coming up! Don&#39;t worry, it&#39;ll be dumbed down/simplified for fellow smoothbrains.</p></div><p>An example of a Unet (not the one stable diffusion) could look like this:<br><img src="https://i.imgur.com/GuVbLWn.png" alt="Image 1: some random Unet example" loading="lazy"></p><p>Or simplified:<br><img src="https://i.imgur.com/wOgN1W1.png" alt="Image 2: simplified Unet example" loading="lazy"></p><p>When doing a classic merge using the <code>Checkpoint merger</code>-tab, the weights of the two model Unets are combined like this:<br><img src="https://i.imgur.com/Xiq8wQc.png" alt="Image 3: classic merging visualization" loading="lazy"><br> All weights are mixed uniformely, according to the Multiplier value set in the UI.</p><p>Things work a bit differently for Block merging:<br><img src="https://i.imgur.com/QD5RmXv.png" alt="Image 4: block merging visualization" loading="lazy"><br> Here you can change the ratio between models on a per-layer (or &#39;block&#39;) basis, giving you much more fine control.</p><h3 id="the-layers" tabindex="-1"><a class="header-anchor" href="#the-layers"><span>The layers</span></a></h3><p>Okay, but what do the layers actually mean?<br> The unfortunate answer: we don&#39;t know (yet). It differs a bit from model to model and is not an exact science.</p><p>Still, you can roughly imagine it like this:</p><div class="hint-container warning"><p class="hint-container-title">Warning</p><p>This image is to be understood as a technically incorrect simplification that&#39;s useful to explain the information useful for casual SD users. Be <em>very</em> careful when building theories based on this explanation.</p></div><figure><img src="https://i.imgur.com/kCHMxCE.png" alt="Image 5: The UNet layers illustrated" tabindex="0" loading="lazy"><figcaption>Image 5: The UNet layers illustrated</figcaption></figure><p>So, rule of thumb: Near middle high level concepts, away from the middle low level concepts.<br> We&#39;ll be taking a look at what that looks like in term of using the UI later.</p><h3 id="what-do-i-need-to-get-started" tabindex="-1"><a class="header-anchor" href="#what-do-i-need-to-get-started"><span>What do I need to get started?</span></a></h3><h4 id="mandatory" tabindex="-1"><a class="header-anchor" href="#mandatory"><span>Mandatory</span></a></h4><p>A basic understanding of classic merging.<br> You&#39;ll need <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui" target="_blank" rel="noopener noreferrer">Automatic1111&#39;s webui</a> and the most up-to-date <a href="https://github.com/bbc-mc/sdweb-merge-block-weighted-gui" target="_blank" rel="noopener noreferrer">merge block weighted gui script</a>.<br> You will also most likely generate dozens of temporary models during research, which you will rapidly cycle between for testing purposes.<br> Not having your models located on an SSD is gonna slow you down <em>considerably</em>.<br> You&#39;ll also need to have enough space on your SSD to store a not insignificant amount of models at once.</p><p>Additionally you will most likely generate broken models from time to time. As of <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui/commit/9991967f40120b88a1dc925fdf7d747d5e016888" target="_blank" rel="noopener noreferrer">commit 9991967</a> the webui has a NaN-checker included, which is supposed to make it easier to figure out what exactly is causing your image generation to generate no output/black images.<br> When experimenting with model merges this causes problems however, since it interrupts the X/Y plot script.<br> So add <code>--disable-nan-check</code> to your command line arguments to disable this feature.</p><h4 id="optional" tabindex="-1"><a class="header-anchor" href="#optional"><span>Optional</span></a></h4><div class="hint-container warning"><p class="hint-container-title">NSFW LINKS</p><p>Cover your virgin eyes anon!</p></div><p>Not necessary, but probably helpful for your own experimentation are classic merging recipes like the ones that can be found <a href="https://rentry.org/LFTBL" target="_blank" rel="noopener noreferrer">the emporium</a> and the <a href="https://rentry.org/hdgrecipes#hdg-stable-diffusion-models-cookbook" target="_blank" rel="noopener noreferrer">/hdg/ model cookbook</a>, you can use those as starting point.</p><p>As of 2023/01/24 the X/Y plot has been expanded by a third axis and is now the X/Y/Z plot. If you haven&#39;t updated in a while, it&#39;s heavily recommended just for that feature alone.</p><p>With the <a href="https://github.com/ashen-sensored/sd-webui-runtime-block-merge" target="_blank" rel="noopener noreferrer">Runtime block merge script</a> you can see the result of a block merge without the need to create a new model, allowing for fast iteration of ideas. It has <em>almost</em> the same parameters as the block merge UI, so following this guide should give you some insights about how to use it.<br> The <a href="https://github.com/ashen-sensored/sd_webui_runtime_ensembling" target="_blank" rel="noopener noreferrer">Runtime ensembling script</a> apparently allows for something similar, though I haven&#39;t tested it yet.</p><p>The preset manager is also a huge time saver, since you will be testing the exact same generation parameters over and over again.<br> But no need for those at first, follow along without them for now.</p><h2 id="understanding-the-interface" tabindex="-1"><a class="header-anchor" href="#understanding-the-interface"><span>Understanding the interface</span></a></h2><p>Okay, so you open up the interface and are immediately overwhelmed by 9001 different sliders and settings.<br> Don&#39;t worry little anon, we&#39;ll start simple by replicating a traditional merge in this new UI and then deviate from there.<br> But before we do that, take a look at these two buttons in the Merge Block UI:</p><figure><img src="https://i.imgur.com/74aVc60.png" alt="Image 6: Preset and Weight Value buttons" tabindex="0" loading="lazy"><figcaption>Image 6: Preset and Weight Value buttons</figcaption></figure><p>These two little things will be your best friend, as they allow you to choose a large variety of presets to start your work from, as well as load in some recipes you found on mesopotamian llama combing forums.</p><p>During your attempts of merging models you will generate an incredible amount of models. Eventually you <em>will</em> forget things and/or will want to go back to things you generated in the past. It&#39;s recommended setting up a textfile in which you keep track of all the models you generate, the names you assign to them and all the settings you used when generating them.</p><p>Also, settle for a format when naming your models early on and don&#39;t deviate from it. AModelname_BModelname_Preset_Additionalsettings_ParameterValue saved into a folder named after the Parameter you are currently experimenting on is one that has worked well for me.</p><p>So, let&#39;s start with a very basic classic merge, the 50:50 split:</p><p>Choose a photorealistic and an anime model for now, it makes it easier to see the results of playing with the sliders.</p><figure><img src="https://i.imgur.com/XxLR4Z7.png" alt="Image 7: Classic 50:50 merge example" tabindex="0" loading="lazy"><figcaption>Image 7: Classic 50:50 merge example</figcaption></figure><p>If you go over to the Merge Block tab, you can replicate this exact merge by entering the following values:</p><figure><img src="https://i.imgur.com/aUZpk5C.png" alt="Image 8: Block Merge 50:50 merge example" tabindex="0" loading="lazy"><figcaption>Image 8: Block Merge 50:50 merge example</figcaption></figure><p>You can also always press the &quot;Clear values&quot; button to reset all sliders to the 0.5 default value. <strong>You will have to manually set base_alpha to 0.5 though</strong>.</p><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>Safetensors doesn&#39;t change the model look but is just the default format that people use nowadays.<br> &quot;Skip/Reset CLIP position_ids&quot;: Force Reset will fix some broken values in the CLIP layer and potentially save you a lot of headaches, but can potentially change the look of the resulting model.<br> If you want to learn more about that settings, check out this guide by some other anon: <a href="https://rentry.org/clipfix" target="_blank" rel="noopener noreferrer">Clipfix</a></p></div><p>I color-coded the equivalent of the classic and block merge UI here:</p><figure><img src="https://i.imgur.com/jBAvAjk.png" alt="Image 9: Side-by-side comparison of classic and block merge UI" tabindex="0" loading="lazy"><figcaption>Image 9: Side-by-side comparison of classic and block merge UI</figcaption></figure><h3 id="tangent-understanding-the-weight-values-field" tabindex="-1"><a class="header-anchor" href="#tangent-understanding-the-weight-values-field"><span>Tangent: Understanding the Weight Values field</span></a></h3><p>On a sidenote: the 13 values you can enter in the Weight Values field refer to the weights of the IN00-IN11, M00 and OUT00-OUT11 blocks, in that order. One thing that is quite easy to miss however is that, due to the way the UI chose to order the sliders with the blocks closer to the center of the Unet further to the bottom, the IN-blocks count up, while the OUT-blocks count down.<br> Not of particular importance for most people, but a thing that can cause a bit of a headache when falsely assuming equivalence between IN00 and OUT00 for example.</p><figure><img src="https://i.imgur.com/x7BFGi8.png" alt="Image 10: Demonstration of Slider order" tabindex="0" loading="lazy"><figcaption>Image 10: Demonstration of Slider order</figcaption></figure><h3 id="comparing-results" tabindex="-1"><a class="header-anchor" href="#comparing-results"><span>Comparing results</span></a></h3><p>To see that the two models are truly the same we unfortunately cannot rely on checksums, as tiny inaccuracies in double precision math will always result in small descripancies between files, which result in distinct checksums.<br> We can however simply generate the same images with the same prompts and settings using both models and compare the results.</p><p>To automate this, it is <em>highly</em> recommended that you use the XYZ Plot script, for one simple reason:<br> This way you can create prompt/negative prompt pairings describing a <em>style</em> (e.g. photorealistic, anime, semirealistic) and save them as <em>styles</em> in the webui, and then create prompt/negative prompt pairings describing a <em>subject matter</em> and also save them as <em>styles</em>, and automatically combine these two using the XYZ plot, and compare them against the different models.</p><p>Here are some styles that I use for comparison purposes:</p><table><thead><tr><th>Style name</th><th>Prompt</th><th>Negative prompt</th></tr></thead><tbody><tr><td>Photo</td><td>DSLR RAW filmgrain photo, shot on iphone, photography, edited in Adobe Lightroom</td><td>anime, illustration, 3d, octane render, drawing, cell shading, semi-realistic, cgi, sketch, cartoon</td></tr><tr><td>3D</td><td>3d octane render, unreal engine raytraced screenshot, cgi, photorealistic</td><td>photo, DSLR, cell shading, anime, illustration, drawing, sketch, cartoon</td></tr><tr><td>Anime</td><td>anime absurdres illustration, drawing, (lineart:0.6)</td><td>photo, DSLR, 3d, cell shading, octane render, cgi, unreal engine</td></tr></tbody></table><table><thead><tr><th>Style name</th><th>Prompt</th><th>Negative prompt</th></tr></thead><tbody><tr><td>Person</td><td>woman sleeping slumped over in the rain during the nighttime festival, wet hair, perfect anatomy</td><td>ugly, old, nsfw, big breasts, bad hands</td></tr><tr><td>Organic</td><td>ancient giant tree in the deep jungle, birds in the branches, fog at dawn, beautiful scenery</td><td>interior</td></tr><tr><td>Urban</td><td>modern skyscraper towering over an old abandoned medieval town, sheds and taverns, storm clouds, urban setting</td><td>rural, portrait</td></tr><tr><td>Car</td><td>a classic, orange convertible sports car driving through shallow beach water</td><td>SUV</td></tr></tbody></table><p>Basically, you want to test for as many distinct styles and subjects as possible, to detect negative effects from mixing in certain models as early as possible. This prevents accidental overfitting/overspecialication and hopefully will also keep your model useful for other people to use in their own merge recipes.<br> Other prompts that would probably make sense to test would be:</p><ul><li>SFW</li><li>NSFW</li><li>Female Human</li><li>Male Human</li><li>Natural language descriptions</li><li>Booru tag descriptions</li></ul><p>Once you are done saving these styles, you can set up your interface for testing:</p><figure><img src="https://i.imgur.com/IkjdfNC.png" alt="Image 11: Settings for generating comparisons" tabindex="0" loading="lazy"><figcaption>Image 11: Settings for generating comparisons</figcaption></figure><p>With all of that set up, we are finally ready to see the result of our hard work:</p><h4 id="classical-block-merge-equivalency" tabindex="-1"><a class="header-anchor" href="#classical-block-merge-equivalency"><span>Classical / Block Merge equivalency</span></a></h4><figure><img src="https://i.imgur.com/YHZDpJc.jpg" alt="Image 12: Comparison between the classic merge model and block merge model" tabindex="0" loading="lazy"><figcaption>Image 12: Comparison between the classic merge model and block merge model</figcaption></figure><p>As you can see, the two mixes</p><p><code>Classic Merge: Multiplier 0.5, Weighted Sum, Copy config from A, B or C</code><br> and<br><code>Block Merge: base_alpha 0.5, Skip/Reset CLIP position IDs: None, Weight values: 0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5</code><br> are identical.</p><p>The load order of the models also makes no difference.</p><div class="hint-container tip"><p class="hint-container-title">SIDENOTE</p><p><em>&quot;Identical&quot;</em> in this case means as close as double precision math and the inherent randomness of diffusion allow.<br> To demonstrate, if you generate three models with the <em>exact same settings</em> after one another, you will end up with three models with three different checksums:<br><img src="https://i.imgur.com/UVkSy4V.png" alt="Image 13: three model checksum problem" loading="lazy"></p><p>Apparently there exists a script to compare model similarity (<a href="https://huggingface.co/JosephusCheung/ASimilarityCalculatior" target="_blank" rel="noopener noreferrer">ASimilarityCalculatior</a>), unfortunately I haven&#39;t been able to figure out how to run it.</p></div><h2 id="block-merging-what-s-what" tabindex="-1"><a class="header-anchor" href="#block-merging-what-s-what"><span>Block Merging: what&#39;s what</span></a></h2><h3 id="base-alpha-the-text-encoder" tabindex="-1"><a class="header-anchor" href="#base-alpha-the-text-encoder"><span>base_alpha / the text encoder</span></a></h3><p>Now that we&#39;ve demonstrated the very basics of the block merge process, we&#39;ll take a closer look at the different things about it that differ from the classic merge, starting with base_alpha.<br> What is base_alpha?<br><img src="https://i.imgur.com/o6ttLmR.png" alt="Image 14: base_alpha slider" loading="lazy"><br> Remember how I explained that a model is made up of text encoder, VAE and Unet?<br> Base_alpha determines which text encoder gets used.</p><p>Imagine the text encoder as a translator between you and a foreign artist. The artist doesn&#39;t doesn&#39;t speak your language, so they only knows what you want by the translator&#39;s interpretation of what you asked them to convey.<br> Imagine you asked the translator to convey you want a picture of &quot;Pepe the frog at the beach&quot;, but the translator had never seen Pepe in their life.<br> The translator could try their best to describe a man called Pepe, what a frog and what a beach looks like, and the artist would faithfully recreat that description, but you would still not end up with what you actually wanted.<br> By chosing or mixing the text encoder, you can basically influence which experiences the translator had in their life, changing how your prompt gets translated into machine-speak.</p><figure><img src="https://i.imgur.com/0GzuotG.jpg" alt="Image 15: base_alpha different values" tabindex="0" loading="lazy"><figcaption>Image 15: base_alpha different values</figcaption></figure><p>This example demonstrates what it&#39;s not enough for the artist (Unet) to know what a Pepe looks like: if the translator (text encoder) can&#39;t communicate what you want, the artist simply will not draw from their experience.</p><p>Now comes the problem:<br><strong>When merging models it is recommended leave the base_alpha value either at 0 or 1, as intermediate values tend to either give bad results or outright break the text encoder. And I don&#39;t know why.</strong></p><p><strong>Automatic1111&#39;s webui also has a feature where it just uses the last text encoder loaded into memory in case the current model has a broken text encoder. This can sometimes make it look like intermediate values for base_alpha look the same as the values 0 and 1, introducing mistakes into your experimentation setup. I had to redo many hours of experimentation when I found this out to confirm my findings. Just don&#39;t set it to anything other than 0 or 1, okay? Trust me on this.</strong></p><p>If you absolutely <em>must</em> mix the text encoder, make sure to enable Skip/Reset clip position ids:<br><img src="https://i.imgur.com/jU0s6G7.png" alt="Image 16: clip position ID reset" loading="lazy"><br> It will help un-break some of the things that get broken by mixing text-encoders. But know that this in itself is also a trade-off.</p><h3 id="unet-weight-mixing" tabindex="-1"><a class="header-anchor" href="#unet-weight-mixing"><span>UNet Weight Mixing</span></a></h3><p>Now for the good part: all those fancy sliders.<br> Remember out brief explanation of how different concepts live on different layers of the models?<br> Overlaying the UI on top of the illustration like this should show the logic behind the UI:</p><figure><img src="https://i.imgur.com/hOC35bo.png" alt="Image 17: UI sliders vs Unet layers" tabindex="0" loading="lazy"><figcaption>Image 17: UI sliders vs Unet layers</figcaption></figure><p>Basically, the creators of the Block Merge UI decided to order the sliders in a way, that the outmost layers are at the top, and the ones closest to the middle are the bottom. Low-level concepts to high-level concepts.<br> Okay, so much about the structure of models - but what we care about isn&#39;t the structure of <em>one</em> model, but the structure of a model that merged together from <em>two</em> other models.</p><p>The script doesn&#39;t just provide us with the means of mixing models, but it also comes with a plethora of mix presets that achieve a variety of interesting combinations of model parts. In the following section we&#39;ll be exploring these presets by illustrating their inner structure: In these previews of the resulting model structure blue blocks represent data from the model in the A slot, red blocks represent data from the B slot and purple represent a mix.</p><h3 id="mix-presets" tabindex="-1"><a class="header-anchor" href="#mix-presets"><span>Mix Presets</span></a></h3><table><thead><tr><th>Main</th><th>(Pseudo) Reverse</th></tr></thead><tbody><tr><td><img src="https://i.imgur.com/dmWfvCn.png" alt="Image 18: ALL_A Preset" loading="lazy"></td><td><img src="https://i.imgur.com/G7BkEbE.png" alt="Image 19: ALL_B Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/xUkae46.png" alt="Image 20: GRAD_V Preset" loading="lazy"></td><td><img src="https://i.imgur.com/Dii0QjZ.png" alt="Image 21: GRAD_A Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/OX5Ru6X.png" alt="Image 22: FLAT_25 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/ONWNL8K.png" alt="Image 23: FLAT_75 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/F5RI8vG.png" alt="Image 24: SMOOTHSTEP Preset" loading="lazy"></td><td><img src="https://i.imgur.com/ltgUakn.png" alt="Image 25: REVERSE-SMOOTHSTEP Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/uZm0nHi.png" alt="Image 26: SMOOTHSTEP�klzzwxh:0132�2 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/8iyLAgZ.png" alt="Image 27: R_SMOOTHSTEP�klzzwxh:0134�2 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/h5dVSso.png" alt="Image 28: SMOOTHSTEP�klzzwxh:0128�3 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/IDSzy0T.png" alt="Image 29: R_SMOOTHSTEP�klzzwxh:0130�3 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/d2Zj6wr.png" alt="Image 30: SMOOTHSTEP�klzzwxh:0124�4 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/PNjBDtV.png" alt="Image 31: R_SMOOTHSTEP�klzzwxh:0126�4 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/p5X45Fl.png" alt="Image 32: SMOOTHSTEP/2 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/rOX0Lt7.png" alt="Image 33: R_SMOOTHSTEP/2 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/qiP4yxx.png" alt="Image 34: SMOOTHSTEP/3 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/GLJ5Q4e.png" alt="Image 35: R_SMOOTHSTEP/3 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/BKkVFVL.png" alt="Image 36: SMOOTHSTEP/4 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/jTmMT5k.png" alt="Image 37: R_SMOOTHSTEP/4 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/0KS4PPA.png" alt="Image 38: COSINE Preset" loading="lazy"></td><td><img src="https://i.imgur.com/E9CJ5FD.png" alt="Image 39: REVERSE_COSINE Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/2VmnGqu.png" alt="Image 40: TRUE_CUBIC_HERMITE Preset" loading="lazy"></td><td><img src="https://i.imgur.com/SnMTYcL.png" alt="Image 41: TRUE_REVERSE_CUBIC_HERMITE Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/y3p3pQR.png" alt="Image 42: FAKE_CUBIC_HERMITE Preset" loading="lazy"></td><td><img src="https://i.imgur.com/3rCxsiS.png" alt="Image 43: FAKE_REVERSE_CUBIC_HERMITE Preset" loading="lazy"></td></tr></tbody></table><p>The following presets don&#39;t have &quot;Reverse&quot; presets, you achieve the opposite by swapping Model A and B (and adjusting base_alpha if wanted).</p><table><thead><tr><th>Preset</th><th>Preset</th></tr></thead><tbody><tr><td><img src="https://i.imgur.com/RrHSQ6p.png" alt="Image 44: WRAP08 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/kej1lTJ.png" alt="Image 45: WRAP12 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/Io2ZnCT.png" alt="Image 46: WRAP14 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/0sUHNf8.png" alt="Image 47: WRAP16 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/BnQAirq.png" alt="Image 48: MID12_50 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/x9B9CpR.png" alt="Image 49: OUT07 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/KX3BHo9.png" alt="Image 50: OUT12 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/RSqbmvy.png" alt="Image 51: OUT12_5 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/5oA2Rm7.png" alt="Image 52: RING08_SOFT Preset" loading="lazy"></td><td><img src="https://i.imgur.com/L5EQBYO.png" alt="Image 53: RING08_5 Preset" loading="lazy"></td></tr><tr><td><img src="https://i.imgur.com/t6yBZ8l.png" alt="Image 54: RING10_5 Preset" loading="lazy"></td><td><img src="https://i.imgur.com/sgFTljR.png" alt="Image 55: RING10_3 Preset" loading="lazy"></td></tr></tbody></table><p><a href="https://github.com/bbc-mc/sdweb-merge-block-weighted-gui#presets-grids" target="_blank" rel="noopener noreferrer">More explanations</a></p><h2 id="recipes" tabindex="-1"><a class="header-anchor" href="#recipes"><span>Recipes</span></a></h2><h3 id="mwb-each" tabindex="-1"><a class="header-anchor" href="#mwb-each"><span>MWB Each</span></a></h3><p>I haven&#39;t explained the MWB Each tab yet, I&#39;ll have to get to that in the future.<br> The only thing you need to know for now is that you can automate the merging process using the MWB Each section and read more about the available commands <a href="https://github.com/bbc-mc/sdweb-merge-block-weighted-gui/blob/master/README_each.md#available-variables" target="_blank" rel="noopener noreferrer">in the official repo</a>.</p><p>You enter the recipes like this:<br><img src="https://i.imgur.com/h566SWN.png" alt="Image 56: Where to enter recipes" loading="lazy"></p><p>Anyways, here are a few recipes I prepared that can help with exploring merges.</p><p>Be prepared to burn through all of your available disk space. If a full model takes up 7gb of diskspace, running the recipe for all possible ratios obviously will generate 70gb worth of models. Settings precision to FP16 can help and later generating at full precision once you found settings you liked, but still: Make sure you are working on an SSD and have enough space available.</p><p>The following recipes assume that you manually selected models for slot A and B. Because of the text encoder issue they also require you to switch the slots of Model A and B afterwards and run them again, if you want the variations with opposite merge order.</p><h4 id="base-alpha-test-recipe" tabindex="-1"><a class="header-anchor" href="#base-alpha-test-recipe"><span>Base_Alpha Test Recipe</span></a></h4><p>Test the three most interesting values of Base_Alpha for a 50:50 merge:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>IN_A_00=0.5, IN_B_00=0.5, OUT_A_00=0.5, OUT_B_00=0.5, M_A_00=0.5</span></span>\n<span class="line"><span>O=A50-50B_0alpha, base_alpha=0.0</span></span>\n<span class="line"><span>O=A50-50B_05alpha, base_alpha=0.5</span></span>\n<span class="line"><span>O=A50-50B_1alpha, base_alpha=1.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ratio-test-recipe" tabindex="-1"><a class="header-anchor" href="#ratio-test-recipe"><span>Ratio Test Recipe</span></a></h4><p>Test all 10% increments of mix-ratios:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Preset_Weights=ALL_A, O=A100-0B, base_alpha=0.0</span></span>\n<span class="line"><span>O=A90-10B, IN_A_00=0.9, IN_B_00=0.1, OUT_A_00=0.9, OUT_B_00=0.1, M_A_00=0.9, M_B_00=0.1, base_alpha=0.1</span></span>\n<span class="line"><span>O=A80-20B, IN_A_00=0.8, IN_B_00=0.2, OUT_A_00=0.8, OUT_B_00=0.2, M_A_00=0.8, M_B_00=0.2, base_alpha=0.2</span></span>\n<span class="line"><span>O=A70-30B, IN_A_00=0.7, IN_B_00=0.3, OUT_A_00=0.7, OUT_B_00=0.3, M_A_00=0.7, M_B_00=0.3, base_alpha=0.3</span></span>\n<span class="line"><span>O=A60-40B, IN_A_00=0.6, IN_B_00=0.4, OUT_A_00=0.6, OUT_B_00=0.4, M_A_00=0.6, M_B_00=0.4, base_alpha=0.4</span></span>\n<span class="line"><span>O=A50-50B, IN_A_00=0.5, IN_B_00=0.5, OUT_A_00=0.5, OUT_B_00=0.5, M_A_00=0.5, M_B_00=0.5, base_alpha=0.5</span></span>\n<span class="line"><span>O=A40-60B, IN_A_00=0.4, IN_B_00=0.6, OUT_A_00=0.4, OUT_B_00=0.6, M_A_00=0.4, M_B_00=0.6, base_alpha=0.6</span></span>\n<span class="line"><span>O=A30-70B, IN_A_00=0.3, IN_B_00=0.7, OUT_A_00=0.3, OUT_B_00=0.7, M_A_00=0.3, M_B_00=0.7, base_alpha=0.7</span></span>\n<span class="line"><span>O=A20-80B, IN_A_00=0.2, IN_B_00=0.8, OUT_A_00=0.2, OUT_B_00=0.8, M_A_00=0.2, M_B_00=0.8, base_alpha=0.8</span></span>\n<span class="line"><span>O=A10-90B, IN_A_00=0.1, IN_B_00=0.9, OUT_A_00=0.1, OUT_B_00=0.9, M_A_00=0.1, M_B_00=0.9, base_alpha=0.9</span></span>\n<span class="line"><span>O=A0-100B, IN_A_00=0.0, IN_B_00=1.0, OUT_A_00=0.0, OUT_B_00=1.0, M_A_00=0.0, M_B_00=1.0, base_alpha=1.0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="input-layer-swap-test-recipe" tabindex="-1"><a class="header-anchor" href="#input-layer-swap-test-recipe"><span>Input Layer Swap Test Recipe</span></a></h4><p>Test swapping individual input layers (sometimes breaks the resulting model)</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN00swap, IN_A_00=0, IN_B_00=1, base_alpha=0.0</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN01swap, IN_A_01=0, IN_B_01=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN02swap, IN_A_02=0, IN_B_02=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN03swap, IN_A_03=0, IN_B_03=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN04swap, IN_A_04=0, IN_B_04=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN05swap, IN_A_05=0, IN_B_05=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN06swap, IN_A_06=0, IN_B_06=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN07swap, IN_A_07=0, IN_B_07=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN08swap, IN_A_08=0, IN_B_08=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN09swap, IN_A_09=0, IN_B_09=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN10swap, IN_A_10=0, IN_B_10=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_IN11swap, IN_A_11=0, IN_B_11=1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="output-layer-swap-test-recipe" tabindex="-1"><a class="header-anchor" href="#output-layer-swap-test-recipe"><span>Output Layer Swap Test Recipe</span></a></h4><p>Test swapping individual output layers (sometimes breaks the resulting model)</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT00swap, OUT_A_00=0, OUT_B_00=1, base_alpha=0.0</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT01swap, OUT_A_01=0, OUT_B_01=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT02swap, OUT_A_02=0, OUT_B_02=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT03swap, OUT_A_03=0, OUT_B_03=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT04swap, OUT_A_04=0, OUT_B_04=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT05swap, OUT_A_05=0, OUT_B_05=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT06swap, OUT_A_06=0, OUT_B_06=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT07swap, OUT_A_07=0, OUT_B_07=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT08swap, OUT_A_08=0, OUT_B_08=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT09swap, OUT_A_09=0, OUT_B_09=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT10swap, OUT_A_10=0, OUT_B_10=1</span></span>\n<span class="line"><span>Preset_Weights=ALL_A, O=AllA_OUT11swap, OUT_A_11=0, OUT_B_11=1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="links-and-other-guides" tabindex="-1"><a class="header-anchor" href="#links-and-other-guides"><span>Links and other guides</span></a></h2><p>As my own research into block merging slows down, other people are stepping up to look deeper into the workings of this technique.</p><p>Noteworthy developments:</p><ul><li><a href="https://github.com/hako-mikan/sd-webui-supermerger" target="_blank" rel="noopener noreferrer">sd-webui-supermerger</a> - Apparently some people prefer this for block merging</li><li><a href="https://github.com/hako-mikan/sd-webui-lora-block-weight" target="_blank" rel="noopener noreferrer">sd-webui-lora-block-weight</a> - You can now block-merge LoRAs</li><li><a href="https://github.com/Xerxemi/sdweb-auto-MBW" target="_blank" rel="noopener noreferrer">sdweb-auto-MBW</a> - An automated brute-force approach to block merging</li><li><a href="https://rentry.org/Merge_Block_Weight_-china-_v1_Beta" target="_blank" rel="noopener noreferrer">Merge_Block_Weight_-china-_v1_Beta</a> - A (machine?) translated version of some Chinese block merging guide</li></ul>',109)]))}]]),r=JSON.parse('{"path":"/posts/reprints/what-is-block-merging.html","title":"What is Block Merging?","lang":"en-US","frontmatter":{"title":"What is Block Merging?","description":"A comprehensive guide to understanding and using the Block Merge technique for Stable Diffusion models","date":"2023-01-19T00:00:00.000Z","author":"researchanon","originalUrl":"https://rentry.org/BlockMergeExplained","lastUpdated":"2023-03-10T00:00:00.000Z","tags":["StableDiffusion","ModelMerging","AUTOMATIC1111","AI"],"gitInclude":[],"head":[["meta",{"property":"og:url","content":"https://neverbiasu.github.io/posts/reprints/what-is-block-merging.html"}],["meta",{"property":"og:site_name","content":"Nlog"}],["meta",{"property":"og:title","content":"What is Block Merging?"}],["meta",{"property":"og:description","content":"A comprehensive guide to understanding and using the Block Merge technique for Stable Diffusion models"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://i.imgur.com/GuVbLWn.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"article:author","content":"researchanon"}],["meta",{"property":"article:tag","content":"StableDiffusion"}],["meta",{"property":"article:tag","content":"ModelMerging"}],["meta",{"property":"article:tag","content":"AUTOMATIC1111"}],["meta",{"property":"article:tag","content":"AI"}],["meta",{"property":"article:published_time","content":"2023-01-19T00:00:00.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"What is Block Merging?\\",\\"image\\":[\\"https://i.imgur.com/GuVbLWn.png\\",\\"https://i.imgur.com/wOgN1W1.png\\",\\"https://i.imgur.com/Xiq8wQc.png\\",\\"https://i.imgur.com/QD5RmXv.png\\",\\"https://i.imgur.com/kCHMxCE.png\\",\\"https://i.imgur.com/74aVc60.png\\",\\"https://i.imgur.com/XxLR4Z7.png\\",\\"https://i.imgur.com/aUZpk5C.png\\",\\"https://i.imgur.com/jBAvAjk.png\\",\\"https://i.imgur.com/x7BFGi8.png\\",\\"https://i.imgur.com/IkjdfNC.png\\",\\"https://i.imgur.com/YHZDpJc.jpg\\",\\"https://i.imgur.com/UVkSy4V.png\\",\\"https://i.imgur.com/o6ttLmR.png\\",\\"https://i.imgur.com/0GzuotG.jpg\\",\\"https://i.imgur.com/jU0s6G7.png\\",\\"https://i.imgur.com/hOC35bo.png\\",\\"https://i.imgur.com/dmWfvCn.png\\",\\"https://i.imgur.com/G7BkEbE.png\\",\\"https://i.imgur.com/xUkae46.png\\",\\"https://i.imgur.com/Dii0QjZ.png\\",\\"https://i.imgur.com/OX5Ru6X.png\\",\\"https://i.imgur.com/ONWNL8K.png\\",\\"https://i.imgur.com/F5RI8vG.png\\",\\"https://i.imgur.com/ltgUakn.png\\",\\"https://i.imgur.com/uZm0nHi.png\\",\\"https://i.imgur.com/8iyLAgZ.png\\",\\"https://i.imgur.com/h5dVSso.png\\",\\"https://i.imgur.com/IDSzy0T.png\\",\\"https://i.imgur.com/d2Zj6wr.png\\",\\"https://i.imgur.com/PNjBDtV.png\\",\\"https://i.imgur.com/p5X45Fl.png\\",\\"https://i.imgur.com/rOX0Lt7.png\\",\\"https://i.imgur.com/qiP4yxx.png\\",\\"https://i.imgur.com/GLJ5Q4e.png\\",\\"https://i.imgur.com/BKkVFVL.png\\",\\"https://i.imgur.com/jTmMT5k.png\\",\\"https://i.imgur.com/0KS4PPA.png\\",\\"https://i.imgur.com/E9CJ5FD.png\\",\\"https://i.imgur.com/2VmnGqu.png\\",\\"https://i.imgur.com/SnMTYcL.png\\",\\"https://i.imgur.com/y3p3pQR.png\\",\\"https://i.imgur.com/3rCxsiS.png\\",\\"https://i.imgur.com/RrHSQ6p.png\\",\\"https://i.imgur.com/kej1lTJ.png\\",\\"https://i.imgur.com/Io2ZnCT.png\\",\\"https://i.imgur.com/0sUHNf8.png\\",\\"https://i.imgur.com/BnQAirq.png\\",\\"https://i.imgur.com/x9B9CpR.png\\",\\"https://i.imgur.com/KX3BHo9.png\\",\\"https://i.imgur.com/RSqbmvy.png\\",\\"https://i.imgur.com/5oA2Rm7.png\\",\\"https://i.imgur.com/L5EQBYO.png\\",\\"https://i.imgur.com/t6yBZ8l.png\\",\\"https://i.imgur.com/sgFTljR.png\\",\\"https://i.imgur.com/h566SWN.png\\"],\\"datePublished\\":\\"2023-01-19T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"researchanon\\"}]}"]]},"headers":[{"level":2,"title":"Changelog","slug":"changelog","link":"#changelog","children":[]},{"level":2,"title":"Table of Contents","slug":"table-of-contents","link":"#table-of-contents","children":[]},{"level":2,"title":"What is Block merging?","slug":"what-is-block-merging-1","link":"#what-is-block-merging-1","children":[{"level":3,"title":"The basics","slug":"the-basics","link":"#the-basics","children":[]},{"level":3,"title":"The layers","slug":"the-layers","link":"#the-layers","children":[]},{"level":3,"title":"What do I need to get started?","slug":"what-do-i-need-to-get-started","link":"#what-do-i-need-to-get-started","children":[]}]},{"level":2,"title":"Understanding the interface","slug":"understanding-the-interface","link":"#understanding-the-interface","children":[{"level":3,"title":"Tangent: Understanding the Weight Values field","slug":"tangent-understanding-the-weight-values-field","link":"#tangent-understanding-the-weight-values-field","children":[]},{"level":3,"title":"Comparing results","slug":"comparing-results","link":"#comparing-results","children":[]}]},{"level":2,"title":"Block Merging: what\'s what","slug":"block-merging-what-s-what","link":"#block-merging-what-s-what","children":[{"level":3,"title":"base_alpha / the text encoder","slug":"base-alpha-the-text-encoder","link":"#base-alpha-the-text-encoder","children":[]},{"level":3,"title":"UNet Weight Mixing","slug":"unet-weight-mixing","link":"#unet-weight-mixing","children":[]},{"level":3,"title":"Mix Presets","slug":"mix-presets","link":"#mix-presets","children":[]}]},{"level":2,"title":"Recipes","slug":"recipes","link":"#recipes","children":[{"level":3,"title":"MWB Each","slug":"mwb-each","link":"#mwb-each","children":[]}]},{"level":2,"title":"Links and other guides","slug":"links-and-other-guides","link":"#links-and-other-guides","children":[]}],"readingTime":{"minutes":12.88,"words":3865},"filePathRelative":"posts/reprints/what-is-block-merging.md","localizedDate":"January 19, 2023","excerpt":"\\n<div class=\\"hint-container warning\\">\\n<p class=\\"hint-container-title\\">NOTE</p>\\n<p>This guide is still work in progress. Any and all feedback is highly appreciated, it doesn\'t have to be suggestions, even questions regarding things you didn\'t understand can help me figure out what to refine.</p>\\n</div>"}')}}]);